stages:
  - check
  - deploy

variables:
  PYTHON_IMAGE: "python:3.14-slim"
  NODE_IMAGE: "node:24-alpine"
  POETRY_INSTALL: "poetry"
  PYTEST_JUNIT_PATH: "junit-report.xml"
  PYTEST_COVERAGE_XML: "coverage.xml"

# share caches to speed installs (no guarantee of cross-job race-free venv writes)
cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - .venv/
    - .cache/pypoetry/
    - .cache/pip
    - node_modules/

# poetry setup anchor
.default_poetry_setup: &poetry_setup
  - python -V
  - pip install --upgrade pip
  - pip install ${POETRY_INSTALL}
  - poetry --version
  - poetry config virtualenvs.in-project true
  - poetry install --no-interaction --no-ansi --with dev || poetry install --no-interaction --no-ansi

###############################################################################
# CHECK STAGE: jobs inside this stage run in parallel (if runners are free)
###############################################################################

# Lint (ruff via poetry)
ruff:
  stage: check
  image: $PYTHON_IMAGE
  before_script:
    - *poetry_setup
  script:
    - poetry run ruff check .
  artifacts:
    expire_in: 1 week
    paths:
      - .ruffcache/
    when: always

# Typecheck (pyright) — uses Node image; runs in parallel with ruff/pytest
pyright:
  stage: check
  image: $NODE_IMAGE
  before_script:
    - node -v
    - npm -v
    # prefer project-local pyright if package.json exists
    - |
      if [ -f "package.json" ]; then
        npm ci || npm install
      else
        npm install -g pyright
      fi
  script:
    - if command -v npx >/dev/null 2>&1; then npx pyright ; else pyright ; fi
  artifacts:
    expire_in: 1 week
    paths:
      - node_modules/
    when: always

# Tests (pytest via poetry)
pytest:
  stage: check
  image: $PYTHON_IMAGE
  before_script:
    - *poetry_setup
    - |
      if [ -f "pyproject.toml" ]; then
        poetry run pip install -e . || true
      fi
  script:
    - poetry run pytest -q --maxfail=1 --junitxml=${PYTEST_JUNIT_PATH} --cov=./ --cov-report=xml:${PYTEST_COVERAGE_XML}
  artifacts:
    when: always
    reports:
      junit: ${PYTEST_JUNIT_PATH}
    paths:
      - ${PYTEST_JUNIT_PATH}
      - ${PYTEST_COVERAGE_XML}
      - .pytest_cache/
    expire_in: 1 week

###############################################################################
# deploy placeholder (runs after check stage completes)
###############################################################################
deploy:
  stage: deploy
  image: $PYTHON_IMAGE
  when: manual
  allow_failure: true
  script:
    - echo "Deployment placeholder — add your deployment steps here."
  only:
    - main

