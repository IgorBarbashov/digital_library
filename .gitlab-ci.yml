stages:
  - check
  - deploy

variables:
  PYTHON_IMAGE: "python:3.14-slim"
  NODE_IMAGE: "node:24-alpine"
  POETRY_VERSION: "1.8.3"
  POETRY_INSTALL: "poetry==${POETRY_VERSION}"
  PYTEST_JUNIT_PATH: "junit-report.xml"
  PYTEST_COVERAGE_XML: "coverage.xml"

# Cache configuration for faster builds
cache:
  key: 
    files:
      - poetry.lock
      - package-lock.json
  paths:
    - .venv/
    - .cache/pypoetry/
    - .cache/pip/
    - node_modules/
    - .pytest_cache/
    - .ruff_cache/
  policy: pull-push

# poetry setup anchor
.default_poetry_setup: &poetry_setup
  - python -V
  - pip install --upgrade pip
  - pip install "poetry==${POETRY_VERSION}"
  - poetry --version
  - poetry config virtualenvs.in-project true
  - poetry config installer.max-workers 4
  - poetry install --no-interaction --no-ansi --with dev --no-root


###############################################################################
# CHECK STAGE: jobs inside this stage run in parallel (if runners are free)
###############################################################################

# Lint (ruff via poetry)
ruff:
  stage: check
  image: $PYTHON_IMAGE
  before_script:
    - *poetry_setup
  script:
    - poetry run ruff check .
  artifacts:
    expire_in: 1 week
    paths:
      - .ruffcache/
    when: always

# Typecheck (pyright) — uses Node image; runs in parallel with ruff/pytest
pyright:
  stage: check
  image: $NODE_IMAGE
  before_script:
    - node -v
    - npm -v
    # Install Python and development tools
    - apk add --no-cache python3 py3-pip python3-dev gcc musl-dev
    # Create and activate virtual environment
    - python3 -m venv .venv
    - source .venv/bin/activate
    # Install poetry in the virtual environment
    - pip install "poetry==${POETRY_VERSION}"
    - poetry config virtualenvs.in-project true
    - poetry install --no-interaction --no-ansi --with dev
    # Install pyright
    - |
      if [ -f "package.json" ]; then
        npm ci || npm install
      else
        npm install -g pyright
      fi
  script:
    - export PYTHONPATH=$PWD:$PWD/src
    - if command -v npx >/dev/null 2>&1; then npx pyright ; else pyright ; fi
  artifacts:
    expire_in: 1 week
    paths:
      - node_modules/
    when: always
  cache:
    key: pyright-${CI_COMMIT_REF_SLUG}
    paths:
      - .venv/
      - node_modules/
    policy: pull-push

# Tests (pytest via poetry)
pytest:
  stage: check
  image: $PYTHON_IMAGE
  before_script:
    - *poetry_setup
    - |
      if [ -f "pyproject.toml" ]; then
        poetry run pip install -e . || true
      fi
  script:
    - poetry run pytest -q --maxfail=1 
      --junitxml=${PYTEST_JUNIT_PATH} 
      --cov=src 
      --cov-report=xml:${PYTEST_COVERAGE_XML} 
      --cov-report=term
      --cov-fail-under=80
  coverage: '/TOTAL.+ ([0-9]{1,3}%)/'
  artifacts:
    when: always
    reports:
      junit: ${PYTEST_JUNIT_PATH}
      coverage_report:
        coverage_format: cobertura
        path: ${PYTEST_COVERAGE_XML}
    paths:
      - ${PYTEST_JUNIT_PATH}
      - ${PYTEST_COVERAGE_XML}
      - .pytest_cache/
    expire_in: 1 week

###############################################################################
# DEPLOY STAGE: Deployment to various environments
###############################################################################
deploy:
  stage: deploy
  image: $PYTHON_IMAGE
  when: manual
  allow_failure: true
  script:
    - echo "Deployment placeholder — add your deployment steps here."
  only:
    - main

