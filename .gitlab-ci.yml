stages:
  - build
  - check
  - deploy
# Build Docker image for CI
build-image:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375/
  script:
    - docker build --build-arg INSTALL_DEV=true -t fastapi-project:ci .
  artifacts:
    expire_in: 1 week
    paths:
      - Dockerfile

variables:
  POETRY_VERSION: "1.8.3"
  POETRY_INSTALL: "poetry==${POETRY_VERSION}"
  PYTEST_JUNIT_PATH: "junit-report.xml"
  PYTEST_COVERAGE_XML: "coverage.xml"

# Cache configuration for faster builds
cache:
  key: 
    files:
      - poetry.lock
      - package-lock.json
  paths:
    - .venv/
    - .cache/pypoetry/
    - .cache/pip/
    - node_modules/
    - .pytest_cache/
    - .ruff_cache/
  policy: pull-push

# poetry setup anchor
.default_poetry_setup: &poetry_setup
  - python -V
  - pip install --upgrade pip
  - pip install "poetry==${POETRY_VERSION}"
  - poetry --version
  - poetry config virtualenvs.in-project true
  - poetry config installer.max-workers 4
  - poetry install --no-interaction --no-ansi --with dev --no-root


###############################################################################
# CHECK STAGE: jobs inside this stage run in parallel (if runners are free)
###############################################################################

# Lint (ruff via poetry)
ruff:
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375/
  stage: check
  image: fastapi-project:ci
  script:
    - poetry run ruff check .
  artifacts:
    expire_in: 1 week
    paths:
      - .ruffcache/
    when: always

# Typecheck (pyright)
pyright:
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375/
  stage: check
  image: fastapi-project:ci
  script:
    - export PYTHONPATH=$PWD:$PWD/src
    - poetry run pyright
  artifacts:
    expire_in: 1 week
    paths:
      - node_modules/
    when: always
  cache:
    key: pyright-${CI_COMMIT_REF_SLUG}
    paths:
      - .venv/
      - node_modules/
    policy: pull-push

# Tests (pytest via poetry)
pytest:
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375/
  stage: check
  image: fastapi-project:ci
  script:
    - poetry run pytest -q --maxfail=1 
      --junitxml=${PYTEST_JUNIT_PATH} 
      --cov=src 
      --cov-report=xml:${PYTEST_COVERAGE_XML} 
      --cov-report=term
      --cov-fail-under=80
  coverage: '/TOTAL.+ ([0-9]{1,3}%)/'
  artifacts:
    when: always
    reports:
      junit: ${PYTEST_JUNIT_PATH}
      coverage_report:
        coverage_format: cobertura
        path: ${PYTEST_COVERAGE_XML}
    paths:
      - ${PYTEST_JUNIT_PATH}
      - ${PYTEST_COVERAGE_XML}
      - .pytest_cache/
    expire_in: 1 week

###############################################################################
# DEPLOY STAGE: Deployment to various environments
###############################################################################
deploy:
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375/
  stage: deploy
  image: fastapi-project:ci
  when: manual
  allow_failure: true
  script:
    - echo "Deployment placeholder â€” add your deployment steps here."
  only:
    - main

