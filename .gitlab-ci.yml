stages:
  - build
  - check
  - deploy

# Global variables for docker:dind
variables:
  DOCKER_HOST: "tcp://docker:2375/"
  DOCKER_TLS_CERTDIR: ""
  POETRY_VERSION: "1.8.3"
  PYTEST_JUNIT_PATH: "junit-report.xml"
  PYTEST_COVERAGE_XML: "coverage.xml"

# Cache
cache:
  key:
    files:
      - poetry.lock
      - package-lock.json
  paths:
    - .venv/
    - .cache/pypoetry/
    - .cache/pip/
    - .pytest_cache/
    - .ruff_cache/
  policy: pull-push

# Build and push image to GitLab Container Registry
build-image:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  variables:
    # tag the image with commit short sha to avoid races
    CI_IMAGE_TAG: "$CI_REGISTRY_IMAGE:ci-$CI_COMMIT_SHORT_SHA"
  script:
    - echo "Building docker image and pushing to $CI_IMAGE_TAG"
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_JOB_TOKEN" "$CI_REGISTRY"
    - docker build --build-arg INSTALL_DEV=true -t "$CI_IMAGE_TAG" .
    - docker push "$CI_IMAGE_TAG"
    - docker tag "$CI_IMAGE_TAG" "$CI_REGISTRY_IMAGE:ci-$CI_COMMIT_REF_SLUG" || true
    - docker push "$CI_REGISTRY_IMAGE:ci-$CI_COMMIT_REF_SLUG" || true
  artifacts:
    expire_in: 1 week
    paths:
      - Dockerfile

ruff:
  stage: check
  image: "$CI_REGISTRY_IMAGE:ci-$CI_COMMIT_SHORT_SHA"
  needs:
    - job: build-image
      artifacts: false
  script:
    - poetry run ruff check .
  artifacts:
    expire_in: 1 week
    paths:
      - .ruffcache/
    when: always

pyright:
  stage: check
  image: "$CI_REGISTRY_IMAGE:ci-$CI_COMMIT_SHORT_SHA"
  needs:
    - job: build-image
      artifacts: false
  script:
    - poetry run pyright
  artifacts:
    expire_in: 1 week
    when: always
  cache:
    key: pyright-${CI_COMMIT_REF_SLUG}
    paths:
      - .venv/
    policy: pull-push

pytest:
  stage: check
  image: "$CI_REGISTRY_IMAGE:ci-$CI_COMMIT_SHORT_SHA"
  needs:
    - job: build-image
      artifacts: false
  script:
    - poetry run pytest -q --maxfail=1 --junitxml=${PYTEST_JUNIT_PATH} --cov=src --cov-report=xml:${PYTEST_COVERAGE_XML} --cov-report=term --cov-fail-under=80
  coverage: '/TOTAL.+ ([0-9]{1,3}%)/'
  artifacts:
    when: always
    reports:
      junit: ${PYTEST_JUNIT_PATH}
      coverage_report:
        coverage_format: cobertura
        path: ${PYTEST_COVERAGE_XML}
    paths:
      - ${PYTEST_JUNIT_PATH}
      - ${PYTEST_COVERAGE_XML}
      - .pytest_cache/
    expire_in: 1 week

deploy:
  stage: deploy
  image: "$CI_REGISTRY_IMAGE:ci-$CI_COMMIT_SHORT_SHA"
  when: manual
  allow_failure: true
  script:
    - echo "Deployment placeholder â€” add your deployment steps here."
  only:
    - main
